name: Security CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Slither
      run: |
        pip3 install slither-analyzer
        pip3 install solc-select
        solc-select install 0.8.24
        solc-select use 0.8.24
    
    - name: Run Slither Static Analysis
      run: |
        slither contracts/ --json slither-report.json || true
        if [ -f slither-report.json ]; then
          echo "Slither analysis complete"
          cat slither-report.json
        fi
      continue-on-error: false
    
    - name: Run Solhint Linter
      run: |
        npx solhint 'contracts/**/*.sol'
      continue-on-error: false
    
    - name: Compile Contracts
      run: npx hardhat compile
    
    - name: Run Unit Tests
      run: npx hardhat test
    
    - name: Generate Coverage Report
      run: |
        npx hardhat coverage
        cat coverage/coverage-summary.json
    
    - name: Check Coverage Threshold
      run: |
        COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "Coverage below 80% threshold"
          exit 1
        fi
    
    - name: Gas Report
      run: |
        REPORT_GAS=true npx hardhat test > gas-report.txt
        cat gas-report.txt
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          slither-report.json
          coverage/
          gas-report.txt
    
    - name: Security Check Summary
      run: |
        echo "✅ Static Analysis: Complete"
        echo "✅ Linting: Complete"
        echo "✅ Unit Tests: Passed"
        echo "✅ Coverage: Above Threshold"
        echo "✅ Gas Report: Generated"

  dependency-audit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Audit Dependencies
      run: npm audit --audit-level=moderate
    
    - name: Check for Outdated Packages
      run: npm outdated || true

  contract-size-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check Contract Sizes
      run: |
        npx hardhat size-contracts
        echo "Checking if contracts exceed 24KB limit..."
